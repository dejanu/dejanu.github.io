<!doctype html>
<html lang="en">
<head>
<!-- Required meta tags for responsive -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Footer resources -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
<link rel="stylesheet" href="media/assets/css/style.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-63W456JCZV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-63W456JCZV');
</script>
<title>OpenSearch calculator</title>
</head>

<body>

<div class="root">
  <header>
   <h2>Your <s>trusty</s> OpenSearch calculator</h2>
  </header>
  <div class="content">
    <div class="left-side">
      <div>
        <form method="post" onsubmit="readData(); return false;" class="forms">

          <label for="data_ingest">Value in <b>GB</b> for ingested data in the index (daily):</label>
          <p><input type="text" name="data_ingest" placeholder="Enter value i.e. 50 "></p>

          <label for="retention_period">Value in <b>days</b> for the rentention period:</label>
          <p><input type="text" name="retention_period" placeholder="Enter value i.e. 30"></p>

          <label for="data_nodes">Number of <b>data nodes</b>:</label>
          <p><input type="text" name="data_nodes" placeholder="Enter value i.e. 4"></p>

          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Workload Type
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" data-value="search-intensive" href="#">Search Intensive</a></li>
              <li><a class="dropdown-item" data-value="ingest-intensive" href="#">Ingest Intensive</a></li>
            </ul>
          </div>
    
          <p id="workload-description">Recommendations...</p>
    
          <!-- this gets generated -->
          <div id="shard-size"></div>
          <br>
          <p><button class="btn btn-primary" type="submit">Calculate</button></p>
    
          <hr/>
         
          <div class="vstack gap-3 bg-primary result">
            <div class="p-2" id="shards" >Shards per cluster...</div>
            <div class="p-2" id="nodeshards">Shards per node...</div>
          </div>

        </form>
      </div>
    </div>
    <div class="right-side">
      <div class="accordion" id="accordionExample">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              Shard size
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <p>Ideally shard sizes should be between 10â€“50 GB, the calculations are done based on desired shard size <strong>selection</strong>.</p>
              <p>Shard size impacts both search latency and write performance, too many small shards will exhaust the memory (JVM Heap), and too few large shards prevent OpenSearch from properly distributing requests.</p>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingThree">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
              Number of shards
            </button>
          </h2>
          <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
            <div class="accordion-body">
            <p>There is a limit on how many shards a node can handle, itâ€™s useful to check how many shards a node can accommodate and search, by inspecting <a href="https://opensearch.org/docs/latest/install-and-configure/configuring-opensearch/cluster-settings/#cluster-level-shard-block-and-task-settings">cluster settings documentation</a>.</p>
            <p><code>cluster.max_shards_per_node</code> setting limits the total number of primary and replica shards for the cluster, default is <code>1000</code></p>
            <p><img src="src/indexvssearch.png" class="img-fluid" alt="Responsive image"></p>
          </div>
        </div>
        </div>
        <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            OpenSearch cluster health
          </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <p>ðŸŸ¢ Green: all primary shards and their replicas are allocated to nodes</p>
            <p>ðŸŸ¡ Yellow: all primary shards are allocated to nodes, but some replicas arenâ€™t</p>
            <p>ðŸ”´ Red: at least one primary shard and its replicas are not allocated to any node</p>
            <p>ðŸ“Œ<strong>Unassigned shards cannot be deleted, an unassigned shard is not a corrupted shard, but a missing replica.</strong></p>
            <p>To understand why a shard cannot be allocated to a node, use the OpenSearch API: <code>GET /_cluster/allocation/explain</code>.</p>
          </div>
        </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
              Shard Resource Consumption
            </button>
          </h2>
          <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <p>Each shard is a full <a href="https://lucene.apache.org/core/8_0_0/core/org/apache/lucene/index/package-summary.html">Lucene Index</a>, and each instance of Lucene is a running process that consumes CPU and memory.</p>
              <p>When a shard is involved in an indexing/search request, it uses a CPU to process the request. As a best practice, use an initial scale point of 1.5 vCPU per shard.</p>
              <p>A small set of large shards uses fewer resources than many small shards.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
    function isValidNumber(str) {
      return /^-?\d+(\.\d+)?$/.test(str);
    }

    function setShardsize (shard_size) {
      let shardsPlaceholder = document.getElementById('shard-size');
      shardsPlaceholder.innerHTML = '';
      shard_size.forEach(shard => {
        shardsPlaceholder.innerHTML += `
          <input type="checkbox" name="option" value="${shard}" id="option${shard}" onclick="onlyOne(this)">
          <label for="option${shard}">${shard}GB</label><br>
        `;
      });
    }

     const dropdown = document.querySelector('.dropdown');
        const workloadDescription = document.getElementById('workload-description');

        dropdown.addEventListener('click', function(event) {
          switch (event.target.dataset.value) {
            case 'search-intensive':
              workloadDescription.innerHTML = '<p><strong>Search intensive</strong> prioritizes <strong>low latency</strong> and is suitable for <strong>search workloads</strong>.</p> <p>Recommended shard size <strong>10â€“30GB</strong></p> <p>Replicas improve search performance, so you might want more if you have a read-heavy workload.</p>';
              setShardsize([10, 20, 30]);
              break;
            case 'ingest-intensive':
              workloadDescription.innerHTML = '<p><strong>Ingest intensive</strong> type prioritizes <strong>data indexing</strong>.</p> <p>Recommended shard size <strong>30â€“50GB</strong></p> <p>Increase Index refresh frequency to speed up indexing (default is 1s)</p>';
              setShardsize([30, 40, 50]);
              break;
          }
        });

  function readData() {
      var data_ingest = document.getElementsByName("data_ingest")[0].value;
      var retention_period = document.getElementsByName("retention_period")[0].value;
      var data_nodes = document.getElementsByName("data_nodes")[0].value;
      
      if (isValidNumber(data_ingest) && isValidNumber(retention_period) && isValidNumber(data_nodes)) {
          
        var data_ingest_int = parseInt(data_ingest,10)
        var retention_period_int = parseInt(retention_period,10)
        var data_nodes_int = parseInt(data_nodes,10)
        // formula: total_shards_per_cluster = (data_ingest * retention_period)/shard_size * (1 + replica_factor)

        var checkboxes = document.getElementsByName('option');
            var selectedValue = null;
            checkboxes.forEach((item) => {
                if (item.checked) {
                    selectedValue = item.value;
                }
            });
        shard_size = parseInt(selectedValue,10)

        replica_factor = 1; //replication factor of 1
        primary_shards = Math.ceil(data_ingest_int/shard_size)
      
        index_shards = primary_shards * (1 + replica_factor)
        total_shards_per_cluster = (primary_shards * retention_period_int) * (1 + replica_factor);

        // formula: no_of_shards_per_node = no_of_shard_per_index / no_of_data_nodes
        no_of_shards_per_node = Math.round(total_shards_per_cluster / data_nodes_int)

        document.getElementById("shards").innerHTML = "Shards " + "per index(replication factor of 1): " + index_shards + " Shards per cluster: " + total_shards_per_cluster;
        document.getElementById("nodeshards").innerHTML = "Shards per node: " + no_of_shards_per_node
    
      } else {
          document.getElementById("shards").innerHTML = "Please enter a valid integer value";
          document.getElementById("nodeshards").innerHTML = "Please enter a valid integer value";
      }
  }
  function onlyOne(checkbox) {
            var checkboxes = document.getElementsByName('option');
            checkboxes.forEach((item) => {
                if (item !== checkbox) item.checked = false;
            })
        }
</script>


<style>
  .first-item {
    margin-left: 0 !important;
  }
  input[type="checkbox"] {
    margin-right: 10px;
    margin-left: 10px;
  }

  .root {
    display: grid;
    row-gap: 30px;
    max-width: 1300px;
    margin: auto;
    padding: 30px;
  }

  header {
    justify-self: center;
  }

  .content {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 10px;
  }

  .left-side {
    display: grid;
    /* justify-content: center; */
  }

  @media screen and (max-width: 600px) {
    .content {
      grid-template-columns: 1fr;
    }
  }

  .vstack {
    display: flex;
    flex: 1 1 auto;
    flex-direction: column;
    align-self: stretch;
    border-radius: 5px;
    color: white;
  }
</style>

</body>
</html>